// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

// SAP-like core tables

model MARA {
  // Material master basic data
  MATNR   String  @id @db.VarChar(18)
  MTART   String  @db.Char(4)
  MATKL   String? @db.VarChar(9)
  MEINS   String  @db.Char(3)
  LAEDA   DateTime? @db.Date

  VBAP    VBAP[]   @relation("VBAP_MARA_MATNR")


  @@map("MARA")
}

model KNA1 {
  // Customer master (general)
  KUNNR String @id @db.VarChar(10)
  LAND1 String? @db.Char(2)
  ORT01 String? @db.VarChar(25)
  NAME1 String  @db.VarChar(35)
  REGIO String? @db.VarChar(3)

  VBAK  VBAK[]


  @@map("KNA1")
}

model VBAK {
  // Sales document: Header data
  VBELN String  @id @db.VarChar(10)
  AUART String? @db.Char(4)
  ERDAT DateTime? @db.Date
  KUNNR String  @db.VarChar(10)
  VKORG String? @db.VarChar(4)

  KNA1  KNA1   @relation(fields: [KUNNR], references: [KUNNR])
  VBAP  VBAP[]

  @@index([KUNNR])
  @@map("VBAK")
}

model VBAP {
  // Sales document: Item data
  VBELN String  @db.VarChar(10)
  POSNR String  @db.VarChar(6)
  MATNR String? @db.VarChar(18)
  KWMENG Decimal? @db.Decimal(15, 3)
  WERKS String?  @db.VarChar(4)
  ERDAT DateTime? @db.Date

  VBAK  VBAK   @relation(fields: [VBELN], references: [VBELN])
  MARA  MARA?  @relation("VBAP_MARA_MATNR", fields: [MATNR], references: [MATNR])

  @@id([VBELN, POSNR])
  @@index([MATNR])
  @@index([VBELN])
  @@map("VBAP")
}

// POC persistence models

model SchemaSummary {
  id        String                     @id @default(cuid())
  table     String                     @unique
  summary   String
  embedding Unsupported("vector(1536)")?  // OpenAI ada-002 embedding dimension
  createdAt DateTime                   @default(now())
  updatedAt DateTime                   @updatedAt
}

model GroundTruth {
  id        String   @id @default(cuid())
  version   String
  graph     Json
  createdAt DateTime @default(now())
}

// Enhanced models for intelligent query generation

model ColumnMetadata {
  id                String                     @id @default(cuid())
  tableName         String
  columnName        String
  dataType          String
  isNullable        Boolean
  isPrimaryKey      Boolean
  isForeignKey      Boolean
  referencedTable   String?
  referencedColumn  String?
  
  // Semantic analysis
  semanticType      String?                    // e.g., "identifier", "name", "date", "amount", "status"
  businessContext   String?                    // Business meaning of the column
  description       String?                    // AI-generated description
  embedding         Unsupported("vector(1536)")?  // Semantic embedding
  
  // Sample data analysis
  sampleValues      Json                       // Array of sample values
  valuePatterns     Json                       // Detected patterns (formats, ranges, etc.)
  uniqueValueCount  Int?                       // Number of unique values
  nullPercentage    Float?                     // Percentage of null values
  
  // Relationship hints
  possibleJoinKeys  Json                       // Potential join relationships
  semanticSimilarity Json                      // Similar columns in other tables
  
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  
  @@unique([tableName, columnName])
  @@index([tableName])
  @@index([semanticType])
}

model TableRelationship {
  id              String   @id @default(cuid())
  leftTable       String
  leftColumn      String
  rightTable      String
  rightColumn     String
  relationshipType String  // "foreign_key", "semantic_match", "inferred"
  confidence      Float    // 0.0 to 1.0
  joinType        String   // "inner", "left", "right", "full"
  businessRule    String?  // Business logic for the relationship
  createdAt       DateTime @default(now())
  
  @@unique([leftTable, leftColumn, rightTable, rightColumn])
  @@index([leftTable])
  @@index([rightTable])
}

model QueryTemplate {
  id            String   @id @default(cuid())
  name          String
  description   String
  pattern       String   // Natural language pattern
  sqlTemplate   String   // SQL template with placeholders
  requiredTables Json    // Array of required tables
  confidence    Float
  usageCount    Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([pattern])
}

model GeneratedQuery {
  id              String   @id @default(cuid())
  prompt          String
  sql             String
  explanation     String?  // AI-generated explanation of the query
  businessLogic   String?  // Business logic explanation
  confidence      Float
  executionTime   Float?   // Query execution time in ms
  resultCount     Int?     // Number of rows returned
  
  // Query analysis
  tablesUsed      Json     // Array of tables used
  joinTypes       Json     // Types of joins used
  complexity      String   // "simple", "medium", "complex"
  
  // Provenance and validation
  templateUsed    String?  // Template ID if used
  validationStatus String  // "valid", "invalid", "warning"
  validationErrors Json?   // Validation errors if any
  
  createdAt       DateTime @default(now())
  
  @@index([createdAt])
  @@index([confidence])
}
